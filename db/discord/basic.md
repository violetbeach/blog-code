## Discord

Discord는 MongoDB에서 Cassandra를 거쳐서 ScyllaDB로 DB를 바꿨다.

아래에서는 그 얘기를 다룬다.

## 메시지 개수 증가

##### 2015

2015년 개발 당시 Discord는 **MongoDB**와 **ReplicaSet**을 사용했다.

2015년 11년 저장된 메시지가 1억 건에 달하면서 성능 문제가 발생하기 시작했다.
- MongoDB는 데이터를 메모리에 최대한 많이 올린다.
  - 데이터/인덱스 크기가 메모리 크기를 넘어섬
- 지연 시간을 예측할 수 없게 됨

##### 2016

- 2016년 7월 7월: 일 4천만 개 메시지
- 2016년 12월: 일 1억 개 메시지

#### 문제 발생 이유

그러면 메시지가 많은 게 왜 문제가 될까..?

- 읽기/쓰기 비율이 5:5
- 랜덤 액세스가 매우 많이 발생
  - 음성채팅이 많고 메시지는 작았음 
  - 비공개 채팅이 많음
  - (소수 메시지 조회 -> 디스크 랜덤 액세스 발생 -> 캐시 효율 저하)

#### DB 선택 기준

그래서 DB 교체를 결정하게 되었고, 아래의 기준으로 선택을 하게 되었다고 한다.

- 선형 수평 확장: 솔루션 재검토, 수동 재배치(reshard)가 발생해서는 안된다.
- 자동 장애 조치: 야근이 싫어서 서버가 스스로 복구되어야 한다.
- 낮은 유지보수 비용: 데이터가 증가하면 노드만 추가할 수 있어야 한다.
- 검증: 새 기술이 좋지만 검증은 충분히 되어야 한다.
- 예측 가능한 성능:
    - 95%의 응답시간이 80ms를 초과하면 알림
    - Redis나 MemCached에 메시지를 캐싱하지 않아도 되어야 한다. (랜덤 액세스 유발 기능 확장 예정)
- 오버헤드 X: Blob 저장소가 아니어야 한다. (직렬화 역직렬화 성능 이슈)
- 오픈 소스: 스스로 기술을 주도할 수 있어야 한다.

위 기준으로 Discord는 **Cassandra**를 선택하게 된다.

##### 2017

Discord는 12개의 카산드라 노드에 수 십억개의 메시지를 저장해서 사용했다.

적용이 만족스러웠지만, Cassandra는 Java 기반 언어이고 아래 문제가 있었다.

- 툼스톤으로 인해 **10초 GC**가 발생하는 문제가 발생한다.
  - 카산드라는 분산 DB의 데이터 삭제 문제를 **툼스톤**으로 해결한다.
  - 툼스톤 기간을 축소하고, 빈 버킷을 조회하지 않도록해서 완화했다.

#### 2022년

툼스톤 문제는 어떻게 해결을 했지만 아래 문제가 추가로 발생했다.

- 177개의 노드, 메시지는 수 조개
- 많은 동시 읽기 발생: 핫 파티션 -> 성능 문제 -> 대기시간 예측 불가
  - 카산드라는 읽기 비용이 쓰기 비용보다 높다.
- 유지보수 비용 증가
  - SSTable 압축에 따른 Latency 발생 -> gosship dance 운영으로 해결

## ScyllaDB

ScyllaDB는 Cassandra 호환되고 C++로 만들어졌다.

ScyllaDB는 아래의 장점이 있었다.
- GC 문제 X: Java의 GC로 인한 문제는 더이상 발생하지 않았다.
- 데이터 서비스 API
  - 동일 데이터에 대한 여러 요청을 하나로 합쳐서 DB로 요청한다.
  - 쿼리 수가 줄여서 DB 부하가 감소한다.

ScyllaDB를 적용하고 **2022년 5월** 아래의 변화가 있었다.

- 177개 Cassandra 노드 -> 72개 ScyllaDB 노드
  - 노드 디스크 용량 평균 4TB -> 9TB
- 히스토리 메시지 읽기 99% 응답시간: 40-125ms -> 15ms
- 메시지 추가 99%: 5-70ms -> 5ms
- 온콜 대응 감소

적용 후 메시지가 미친듯이 발생하는 2022년 월드컵에 디스코드 개발자들도 각자 집에서 월드컵을 잘 볼 수 있었다고 한다.

## 참고

- https://www.infoq.com/news/2023/06/discord-cassandra-scylladb
- https://www.youtube.com/watch?v=mU3JiOI31Ao