## 카드 결제

카드 결제에서는 세 가지 단계가 있다.

1. 인증
2. 승인
3. 매입
4. 정산

## 1. 인증

고객이 카드로 결제를 요청하면 처음으로 일어나는 게 인증이다. 결제할 카드 정보와 카드 소유자 정보가 맞는 지 확인하는 과정이다.
- 카드번호
- 유효기간
- CVC
- 생년월일
- 결제 비밀번호

비인증 결제도 있는데, 키인 결제(카드번호 결제)가 이에 속한다.

## 2. 승인

PG사는 VAN을 통해 카드사에 카드 승인을 요청한다. 카드사에는 해당 카드 정보, 고객 정보, 결제 정보를 전송한다.
- 체크, 선불은 카드사에서 돈이 빠져나갈 것이다.
- 신용카드에서는 카드의 한도만 차감된다.

## 3. 매입

매입은 PG사가 VAN을 통해 카드사에 승인된 결제 정보에 대한 정보를 알리는 과정이다.

가맹점이 서비스나 상품에 대한 대금을 정산받기 위해 필요하다.

매입을 하지 않으면 가맹점은 정산을 받을 수 없다. 

#### 매입이 필요한 이유

카드 결제 프로덕트를 개발하면 매입 프로세스가 왜 필요한 지를 이해하기 어려운 경우가 많다.

매입이 필요한 이유는 카드사도 결국 남의 돈을 빌려 회원 대신 돈을 내주는 것이기 때문이다.
매입 절차없이 실시간으로 카드사에서 가맹점으로 정산할 경우 아래의 다양한 문제가 발생할 수 있다.

1. 오류 대응이 어렵다.
    - 거래가 '고객 <-> 가맹점 <-> 카드사 <-> 가맹점'으로 훨씬 복잡해지면서 트랜잭션을 유지하기 어려워진다.
    - 오류 건에 대한 추적이 어렵고, 실시간 대응도 어렵다. 복잡한 사후 처리가 필요하여 불만이 커질 수 있다.
2. 정산 비용 증가
    - 실시간 정산을 위해서는 거래 건마다 대금을 즉시 송금해야하므로, 매번 발생하는 송금 수수료와 처리 비용이 기하급수적으로 늘어난다.
    - 서버 리소스 사용도 급증한다. (병목도 생김)
3. 정산 후 조정의 어려움
    - 가맹점으로의 정산이 완료되었을 때 금액을 환불하는 것이 복잡하다.
4. 글로벌 결제에서 환율 변동 문제
    - 해외 결제의 경우 환율 변동으로 인한 손익 문제를 초래할 수 있다.
    - 현재는 매입 시스템에서 매매기준율에 맞춰 정산이 이루어져 안정성을 보장한다. (매매기준율은 전날 모든 외화 환전 거래의 환율 평균 값을 구해 익일 해외 결제 시 환율로 적용된다.)
5. 카드사는 가맹점에 대금을 늦게 정산해야 현금보유량이 많아진다.

## 4. 정산

정산은 PG사 -> 카드사 -> 각 가맹점 구조로 금액을 지급받는 과정을 말한다.
