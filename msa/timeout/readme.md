## MSA 간 동기로 API 호출 시 문제점 (feat. Read Timeout, ..)

MSA간 메시지를 주고 받는 것이 필요할 때가 있다.

MSA에서 아래 서버가 있다고 가정하자.

- 송금 시스템
- 메일 알림 시스템

송금 시스템은 송금이 완료되면 메일로 알림을 보낸다.

가장 쉬운 방법은 동기 API 호출을 떠올릴 수 있다.

## 동기 API 호출 - 문제점

내가 다니는 회사의 레거시한 시스템의 경우 동기 API 호출을 통해 MSA에서 메시지를 주고받고 있다.

짐작 가능한 단점은 당연히 아래의 문제가 있다.
- 서비스 간 성능 및 장애를 공유하게 된다.
  - (1개 시스템의 장애가 MSA 전체의 처리량 저하 및 장애로 이어질 수 있다.)
- 서비스 간의 강결합이 생긴다. (메일 알림이 실패하면 송금도 실패함)

사실 이번 글에서 다루고자하는 내용은 해당 내용보다는 아래의 내용이다.

동기로 API 호출을 한다고 해서 절대 안전한 것이 아니다!

### 동기 API 호출이 안전하지 않다..?

송금 시스템에서 송금이 완료된 후 메일 알림 시스템으로으 요청을 보냈는데 Read Timeout이 났다고 가정하자.

(참고로 Request Timeout의 종류는 대표적으로 3가지가 있다.)
- Connection Timeout
- Socket Timeout
- Read Timeout(응답이 오래 지연되는 경우)

Read Timeout의 경우에는 외부 API의 로직(메일 발송) 자체는 완료되었지만, Read Timeout으로 인해 Client 측의 예외가 발생할 수 있다.

이 경우 메일 알림이 발송이 되었는 지 안되었는 지 Client 측에서는 파악할 수 없게 된다.
- (트랜잭션을 공유한다면) 송금 내용을 롤백해야 하는 지 여부를 파악하기 힘들다.
- (트랜잭션을 분리했따면) 메일 알림이 실제로 보내졌는 지 파악하기 어렵다.
  - (재발송 필요 여부를 판단할 수 없다.)

### 해결 방법

#### 요청 내용 저장

DB를 활용하면 이를 해결할 수 있다. 

DB에 외부 API 요청 내용 을 저장하고, 요청을 처리하는 서버 로직의 트랜잭션에서 해당 요청의 flag를 변경해줄 수 있다.

#### 로그 저장

또 다른 방법으로는 요청을 처리하는 서버에서 한 트랜잭션에서 메일 알림 발송과 더불어 DB에 메일 알림을 발송했다는 로그를 저장하는 것이다.

이 경우 클라이언트인 메인 시스템에서 DB의 로그를 조회해서 발송이 실제로 이뤄졌는지 확인할 수 있다.

이렇게 해야 비로소 서로 다른 서비스 간 안전하게 기능을 수행할 수 있다.

> 추가로 동기로 호출할 경우에 대한 문제를 완화하기 위한 방법이 아래 영상(최범균님 영상)에 잘 정리되어있다! - Timeout, Bulkhead, Fail fast 등에 대해 다룸)
> - https://www.youtube.com/watch?v=nuRO0ZBFdKk&t=147s

## 비동기

사실 위에 있는 내용을 적용할 수고로움에도 여전히 서비스 간 동기 요청에 대한 단점이 있다. (위에서 언급한 외부와 성능 및 장애를 공유하게 되는 부분) 

개발을 잘하는 팀의 얘기를 들어보면 (네카라쿠배당토..) 하는 말이 있다. 이는 비동기 프로세스로 아키텍처를 구현했기에 가능하다.
- 각 서비스는 자신의 일만 잘하면 되요!

(시스템 복잡도는 올라간다는 단점이 있지만!) 재처리/트랜잭션 등에 제약이 약하면 가능한 비동기로 처리하는 것이 좋다.

아래는 비동기로 MSA 간 트랜잭션을 사용하는 방법에 대해서 정리한 글이다. (조금은 답을 찾을 수 있을 것이니 꼭 참고하길 바란다!!)

- https://jaehoney.tistory.com/260
- https://jaehoney.tistory.com/310