마음에 거리는 것은 크게 세 가지가 있었다.
1. Serial GC를 사용하는 점 (k8s Pod가 싱글 스레드였다.)
2. 메모리 누수가 발생한 경우
3. 그냥 요구사항 및 특성에 따른 Heap Size가 모자란 경우

## 1. Serial GC를 사용하는 점

로컬에서랑 다르게 부하 테스트 중인 Dev 서버의 경우 Serial GC를 사용하고 있었다. (다중 코어 프로세스가 아닌 경우에 해당한다. 1개 Pod는 단일 코어로 구성되어 있었다.)

여기서 드는 의문이 실제 운영 환경에서 SerialGC를 사용해도 되냐는 것이다.

GC를 위해 강제로 코어를 올리는 것은 권장되지 않는다. 대신 메모리 사용량을 최적화하고 JVM 튜닝을 통해 메모리 사용을 최소화하는 것이 중요하다.

자원이 제한적인 경우 SerialGC 선택은 합리적일 수 있다고 한다.

우선은 가장 치명적인 내용은 아닌 정도로 넘어가자.

## 2. 메모리 누수가 발생한 경우

아래 사이트를 참고해보면 Memory leak은 Full GC/Major GC가 발생했음에도 Heap이 그대로일 때 발생했다고 추리할 수 있다고 한다.
- https://techblog.woowahan.com/2628/

## 3. Heap Size가 모자란 경우

일반적인 API Server의 경우 적당한 Heap Size가 1GB ~ 2GB 정도라고 한다.

현재 개발중인 Mail API Server의 경우는 512M을 사용하고 있었는데, 너무나 작았던 것 같다. 근거는 아래와 같다.
- 너무 다양한 역할
  - MultiModule을 초기에 도입하지 못해서 해당 프로젝트에는 너무 많은 책임이 있었다. (Schedule, EventListener, ..., 도메인도 다수)
- 메일 본문 조회
  - 메일을 조회할 때 EML 원문을 조회하는데 1KB ~ 25MB 까지도 될 수 있었다.
- 가장 많이 사용되는 서비스
  - 메일 서비스는 하이웍스 내에서 가장 많이 사용되고, 가장 많은 트래픽이 발생되는 서비스이다.

스레드 10개에서 20MB 본문 조회 요청만 해도 OOM이 발생하면서 심각한 문제를 야기한다. 즉, 요구사항이나 본문을 조회하는 로직을 개선하기 전에는 HeapSize 512MB은 턱없이 부족했다.



