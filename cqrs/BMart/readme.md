해당 포스팅은 "B마트 전시 도메인 CQRS 적용하기"라는 강연의 내용을 정리한 글이다.
- https://www.youtube.com/watch?v=fg5xbs59Lro

## CQRS

CQRS는 Command and Query Responsibility Segregation의 약자로 **명령과 조회의 책임을 분리**라는 뜻이다.

이전에 CQRS의 내용을 정리한 적이 있는데 외부 강연들을 보면서 추가로 궁금한 사항들이 생겼다.
- 왜 조회 모델은 DB에 저장을 할까..?!, ...

이전 포스팅은 아래 링크를 참고하자.
- https://jaehoney.tistory.com/255

**B마트 전시 도메인 CQRS 적용하기**라는 강연에서 CQRS에 대해 더 자세히 설명해준다. 해당 강연을 보고 추가적으로 알게된 사실을 해당 포스팅에서 작성하려고 한다.

## 내부 데이터와 외부 데이터

우리는 DB에서 도메인 모델을 꺼낼 수도 있지만, MSA를 적용하고 있다면 외부 API를 통해 모델을 조회할 수도 있다.

![img.png](img.png)

단일 도메인 모델을 사용하면 **명령 관련 로직**과 **조회 관련 로직**이 함께 존재할 수 밖에 없다.

이때 외부 API를 통해 불러온 모델은 Hibernate에서 관리할 수 있는 모델이 아니기에 모델을 다루기에 훨씬 복잡해지고, 변경 용이성이 떨어지게 된다.

![img_1.png](img_1.png)

그래서 큰 도메인 안에서 명령과 도메인과 조회 도메인을 나눠서 문제를 해결하는 것이 CQRS가 나아가는 방향이다.

- 명령 모델: 기존의 모델
- 조회 모델: 각 모델을 결합한 비정규화된 데이터를 한번 더 정의한 것

## 캐시

조회 모델을 만들기 위해서는 여러 쿼리와 외부 API로의 요청이 필요하다. 이는 당연히 성능상의 부담이 된다.

그래서 Cache를 사용해야 한다. 이때 아래의 문제가 생길 수 있다.
- Heap 메모리 사이즈 부족
- 캐시와의 트래픽량 증가

그래서 명령 모델을 통해 데이터가 변경되는 시점에 조회 모델을 생성하고 비정규화된 데이터를 그대로 DB에 다시 저장한다.
- CQRS의 조회모델을 DB로부터 가져오는 과정에서 조인이나 여타 연산을 제한해야 한다.
- 그래서 비정규화된 데이터를 저장해서 DB에서 데이터를 꺼내서 곧바로 사용할 수 있게 한다.

해당 데이터는 비정규화된 데이터이기 때문에 JsonFormat이 주로 이용이된다. 그래서 RDB가 아니라 NoSQL을 사용하는 경우가 많다.
- Redis, Elasticsearch, DynamoDB

단, 이렇게 저장소를 나누면 다른 저장소간 데이터의 정합성을 보장할 수 있어야 하기에, 시스템이 안착할 때 까지는 모니터링에 더 관심을 기울여야 한다.



