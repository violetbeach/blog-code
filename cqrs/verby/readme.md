## 멀티 모듈을 적용하면서 (+ CQRS 적용)

최근 사이드 프로젝트에서 멀티모듈을 적용하면서 생긴 문제점들과 해결 과정을 공유하고자 한다.

우선 결과를 간단하게 설명하자면 아래와 같이 생긴 싱글 모듈 프로젝트를

![img.png](img.png)

아래와 같이 네 개의 모듈로 분리할 수 있었다.

![img_1.png](img_1.png)

추가적으로 Common 모듈이나 다른 모듈로 분리를 추가해도 문제가 없다.

## 멀티 모듈

영상 플랫폼을 개발하면서 아래의 두 가지에 대한 해결이 필요했다. 

### 1. 조회수를 캐싱해서 매번 쿼리를 보내는 것이 아닌 시간 단위로 반영해야 한다. (Write Back)

조회 수를 매번 Update문으로 해결하면 DB에 부하가 매우 커질 것이라고 판단했다.

시간 단위로 Write Back을 해서 DB에 반영할 수 있도록 작업이 필요했고, 해당 작업을 Scheduler로 반영을 하게 되었다.

그래서 해당 API에 Scheduler를 추가하자니 아래의 문제가 있었다.

- 주 관심사인 메인 API로 성능 및 장애가 전파되어도 되는가?
- 메인 API에 코드를 작성해서 한 번에 관리해도 되는가? (메인 프로덕션 코드가 지저분해 질 수 있었다.)

고민 끝에 별도의 Batch Server 프로그램이 필요하다고 판단했다.

### 2. 명령 모델이 생성될 시점에 조회 모델도 생성되어야 한다.

CQRS를 적용하면서 발생한 문제이다.

명령 모델이 생성되면 이벤트를 전파해서 조회 모델을 생성해야 한다.

이때도 아래의 문제가 생길 수 있다.
- 조회 모델 생성이 주 관심사인 메인 API와 성능을 공유한다.
- 조회 모델 생성이 실패하면 주 관심사인 명령 모델 생성도 생성이 실패한다.

사실 이 점이 가장 고민이 많았다.

명령 모델이 생성되면 곧바로 조회가 가능해야 하는 것이 아닐까..?! 그렇다면 조회 모델도 동일한 트랜잭션 내에 존재해야 하는 것이 아닌가..? 하는 고민이었다.

고민을 해소하기 위해 아래의 자료를 참고했다.

- 최범균 - CQRS 아는 척하기 시리즈
- [우아콘2020] 배민 프론트서버의 사실과 오해
- [우아한Tech] B마트 전시 도메인 CQRS 적용하기

해당 강연들에서 주로 볼 내용은 Eventually Consistency(최종적 일관성)이다. 시스템 간 강결합(코드, 성능, 로직)을 제거하고 MQ를 활용한 이벤트 발행을 통해 최종적 일관성을 비 정규화된 데이터 형태로 조회 모델로서 저장하게 된다.

CQRS에서 조회 모델 생성을 비 관심사로 볼 지는 프로젝트의 특징에 따라 다를 것 같다.

개발중인 프로젝트에서는 조회 모델 생성이 **동시**에 이뤄지지 않아도 크게 상관이 없었다. 그래서 Consumer 모듈을 분리를 하게 되었다.

## 모듈 구성

각 모듈에 대한 빌드는 root 프로젝트를 기준으로 진행한다.

각 모듈은 src 패키지와 build.gradle 파일만 존재해야 한다.

![img_2.png](img_2.png)

추가로 멀티 모듈을 (혼자) 처음으로 구성하면서 어려웠던 점이 생각보다 조금 있었던 것 같다.

(QueryDSL, Jacoco, Asciidoctor 때문에 Build.gradle을 구성하는 데에만 하루가 걸렸다.. 특히 QueryDSL...)

각 요소에 대한 설명을 담기에는 포스팅이 너무 커질 수 있어서 아래에서 링크를 첨부했다.

각 모듈에 대한 의존성은 아래 Repository에서 확인할 수 있다. (Gradle 7.5 기반)
- https://github.com/verby-korea/verby-server

## 문제 해결

아래는 멀티 모듈을 구성하기 위해 문제를 해결하면서 알게된 사실이다.

### jar / bootJar

멀티 모듈을 다 구성했고 IntelliJ에서 테스트 및 빌드가 성공하는데 자꾸 CI/CD가 깨지는 현상이 발생했다.

![img_3.png](img_3.png)

에러 내용을 보면 Import가 자꾸 실패한다고 한다.

해당 내용은 IntelliJ에서 Gradle을 Build 할 때는 이상이 없었지만, ./gradlew build와 같이 내장 그래들로 빌드할 경우 빌드가 깨지는 현상이 발생한 것이다.

해당 이유를 결국 찾았는데, 나는 배포할 모듈에서 아래와 같은 빌드를 구성하고 있었다.

```groovy
jar {
    enabled = false
}
```
싱글 모듈 프로젝트할 때 plain-jar가 생기는 것을 방지하기 위해서 추가한 부분이었다.

이 경우 싱글 모듈 프로젝트에서는 문제가 안되지만, 멀티 모듈에서는 문제가 되었다.
- 멀티 모듈에서는 패키지가 다르기 때문에 jar을 disable하면 찾을 수 없다.
- 각 실행 애플리케이션 클래스를 상위 패키지로 올렸기 때문
  - (Component Scan을 위함) 참고: https://techblog.woowahan.com/2637

이 경우 jar task를 enabled(default)로 설정해야 한다.

**<추가>**
해당 작업 때문에 빌드 스크립트가 동작하지 않는 문제가 발생했다. (plain-jar가 잡힘)
```diff
-JAR_NAME=$(ls $REPOSITORY/jar/ |grep 'api-server' | tail -n 1)
+JAR_NAME=$(ls $REPOSITORY/jar/ |grep 'api-server' | head -n 1)
```

그래서 tail을 head로 변경하면서 기본 jar를 잡도록 수정할 수 있었다.

## yml

yaml-importer

## TestFixture

## 추가로 해결할 문제

### 배포

### CQRS

질의



