## 인덱스에 대한 오해 (1개가 빠를까? 2개가 빠를까?)

어느 날 신입 분이 나한테 찾아와서 물었다.

'메일 조회를 할 때 권한이 없으면 404가 아니라 401 또는 403이 나와야 하는 것 아닌가요?'

~~(인덱스 얘기한대놓고 무슨 권한 얘기인지..)~~

나도 쌩신입때 선배분께 동일한 질문을 했었다.

## 오해

아래 코드는 비즈니스에서 Mail을 조회하기 위해 사용되는 코드이다.

```java
mailRepository.findByUserIdAndId(userId, id)
        .orElseThrow(() -> new EntityNotFoundException("Mail", id));
```

여기서 문제는 3가지가 있다.
1. 쿼리에 비즈니스 로직이 들어간다.
    - 가독성이 나빠지고 객체지향적인 설계가 불가능해진다.
    - `프로그래밍 초식의 쿼리에서 로직 빼기` 부분을 참고하자.
2. 자신의 소유가 아닌 메일에 대해서 404(Not Found)가 내려온다.
    - REST 스펙에 따르면 인가와 권한의 문제는 403 Forbidden을 내려주는 것이 바람직한 것 같다.
3. 인덱스가 불필요하게 추가될 위험이 있다.

그래서 나는 `findById()`만 호출한 후 소유권자를 로직으로 비교하고 403 Forbidden으로 처리되어야 하지 않느냐는 질문을 했고

여기서 동료(선배) 분이 '**그렇게 하면 인덱스를 안타잖아요.**' 라는 회신을 주셨다. 완전 쌩신입이던 나는 우선적으로 동의했다.

테이블의 인덱스는 아래와 같았다.
- 기본 키(Primary Key): no
- 인덱스(Non-cluster Key): user_no, no

## 정말 그럴까?

동료 분의 의견은 Index를 하나라도 많은 컬럼을 태워야 성능이 향상된다는 것이다.

현재의 나는 Real MySQL이나 공식 문서를 정독한 경험이 있어서 그렇지 않다고 확신한다.

아래는 Primary Key의 동작 방식을 그린 것이다.

#### 1. Primary Key

https://drive.google.com/file/d/1EwfrvuEE8PslMu7hqI2PpE-UBJtgZlBm/view?usp=sharing








## 결론

결론은 사용해도 된다. 정책 상 `해당 유저의 엔터티가 존재하지 않는 것`으로 바라본다면 404를 내려주는 것도 잘못된 것은 아니다.

다만, 이유를 정확히 알아야 하는 것 같다.